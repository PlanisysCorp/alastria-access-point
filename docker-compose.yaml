version: '3'
services:

  envoy:
    build:
      context: envoy
      dockerfile: Dockerfile
    depends_on:
      - node
    volumes:
      - ./envoy/envoy-config.yaml:/etc/envoy.yaml
    networks:
      - alastria
    expose:
      - "80"
      - "8001"
    ports:
      - "8000:80"
      - "8001:8001"
    restart:
      on-failure

  node:
    build:
      context: node
      dockerfile: Dockerfile
    command: ["${NODE_TYPE}","${NODE_NAME}"]
    volumes:
      - ${DATA_DIR}:/root/alastria
    networks:
      alastria:
        aliases:
          - node
    restart:
      on-failure
          
networks:
  alastria:
